var ut=Object.defineProperty;var ft=(e,n,t)=>n in e?ut(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;var v=(e,n,t)=>(ft(e,typeof n!="symbol"?n+"":n,t),t);import{G as O,a as Z,b as dt,c as gt,A as pt,P as H}from"./HTMLText-DZ17wCYg.js";import{h as vt}from"./pixi_viewport-B8H46PgQ.js";class rt{constructor(n){v(this,"shapeData");v(this,"canvas");v(this,"container");this.canvas=n,this.container=new O}clear(){this.container.removeChildren()}redraw(){this.clear(),this.draw(this.shapeData)}updatePosition(n,t){this.container.position.set(n,t)}}class wt extends rt{constructor(){super(...arguments);v(this,"shapeData");v(this,"color","#666666");v(this,"width",1)}drawLabel(){const t=this.shapeData.source.x,i=this.shapeData.source.y,r=this.shapeData.target.x,s=this.shapeData.target.y,a=new Z(`link ${this.shapeData.source.id}-${this.shapeData.target.id}`,{fontFamily:"Arial",fontSize:12,fill:16777215});return a.x=(t+r)/2,a.y=(i+s)/2,a.resolution=window.devicePixelRatio*2,a.anchor.set(.5),a}drawShape(){var u,y,l,h;let t=new O;t.lineStyle(this.width,16777215);const i=(u=this.shapeData.source)==null?void 0:u.x,r=(y=this.shapeData.source)==null?void 0:y.y,s=(l=this.shapeData.target)==null?void 0:l.x,a=(h=this.shapeData.target)==null?void 0:h.y;t.moveTo(i,r),t.lineTo(s,a);const c=Math.atan2(a-r,s-i),d=10,o=s-d*Math.cos(c-Math.PI/6),g=a-d*Math.sin(c-Math.PI/6),m=s-d*Math.cos(c+Math.PI/6),p=a-d*Math.sin(c+Math.PI/6);return t.moveTo(s,a),t.lineTo(o,g),t.moveTo(s,a),t.lineTo(m,p),t}setupInteractions(t){this.container.cursor="pointer"}draw(t){var r;this.shapeData=t,console.debug("===Drawing  link",(r=this.shapeData)==null?void 0:r.id,this.shapeData),this.container.cursor="pointer";let i=this.drawShape();return this.container.addChild(i),this.container}}class xt extends rt{constructor(t){super(t);v(this,"shapeData");v(this,"color","#ff00ff");v(this,"size",12);v(this,"dragging",!1);v(this,"dragPoint");v(this,"onDragStart",t=>{t.stopPropagation(),this.dragPoint=t.data.getLocalPosition(this.container.parent),this.dragPoint.x-=this.container.x,this.dragPoint.y-=this.container.y,this.container.parent.on("pointermove",this.onDragMove)});v(this,"onDragMove",t=>{const i=t.data.getLocalPosition(this.container.parent),r=i.x-this.dragPoint.x,s=i.y-this.dragPoint.y;this.canvas.stateCtrl.updateNodePosition(this.shapeData.id,r,s),this.updatePosition(r,s);const a=this.canvas.stateCtrl.getNeighborLinks(this.shapeData);this.canvas.renderer.reRenderLinks(a)});v(this,"onDragEnd",t=>{t.stopPropagation(),this.container.parent.off("pointermove",this.onDragMove)})}drawLabel(){const t=new O,i=new dt({fontSize:12,fill:16777215,wordWrap:!0,breakWords:!0}),r=`${this.shapeData.label}`,s=new Z(r,i);s.resolution=window.devicePixelRatio*2;const a=s.getBounds(),c=new O;return c.beginFill(0),c.drawRect(0,0,a.width,a.height),c.endFill(),t.addChild(c),t.addChild(s),s.position.set(c.x,c.y),t}drawShape(){let t=new O;return t.lineStyle(3,16777215),t.beginFill(this.color),t.drawCircle(0,0,this.size),t.interactive=!0,t.cursor="pointer",t.eventMode="static",t.hitArea=new gt(0,0,this.size),t.endFill(),t}pointerOver(){this.container.tint=6710886}pointerOut(){this.container.tint=16777215}updateEdges(){}setupInteractions(){this.container.removeAllListeners(),this.container.cursor="pointer",this.container.on("pointerover",()=>this.pointerOver()),this.container.on("pointerout",()=>this.pointerOut()),this.container.on("pointerdown",this.onDragStart.bind(this)).on("pointerup",this.onDragEnd.bind(this)).on("pointerupoutside",this.onDragEnd.bind(this))}draw(t){var s;this.shapeData=t,this.clear(),console.debug("===Drawing  node",(s=this.shapeData)==null?void 0:s.id,this.shapeData),this.shapeData.size=this.size,this.shapeData.x&&this.shapeData.y&&this.updatePosition(this.shapeData.x,this.shapeData.y);let i=this.drawShape();this.container.addChild(i);let r=this.drawLabel();return this.container.addChild(r),this.setupInteractions(),this.container}}class yt{constructor(n){v(this,"canvas");v(this,"render",()=>{let n=this;this.canvas.clear(),this.canvas.stateCtrl.getLinks().forEach(r=>{if(!r.shapeInstance){const a=new wt(this.canvas);r.shapeInstance=a}const s=r.shapeInstance.draw(r);n.canvas.addShape(s)}),this.canvas.stateCtrl.getNodes().forEach(r=>{if(!r.shapeInstance){const a=new xt(this.canvas);r.shapeInstance=a}const s=r.shapeInstance.draw(r);n.canvas.addShape(s)}),this.renderScreenBorderIfRequired()});this.canvas=n}rerender(){this.render()}tick(){this.reRenderNodes(this.canvas.stateCtrl.getNodes()),this.reRenderLinks(this.canvas.stateCtrl.getLinks()),this.renderScreenBorderIfRequired()}setNodePosition(){}reRenderNodes(n){n.forEach(t=>{var s;let{x:i,y:r}=t;this.canvas.stateCtrl.updateNodePosition(t.id,i,r),(s=t.shapeInstance)==null||s.updatePosition(i,r)}),this.renderScreenBorderIfRequired()}reRenderLinks(n){n.forEach(t=>{var i;(i=t.shapeInstance)==null||i.redraw()}),this.renderScreenBorderIfRequired()}renderScreenBorderIfRequired(){this.canvas.debug_mode?this.canvas.screenBorderDraw():this.canvas.screenBorderClear()}}class mt extends vt{constructor(){super(...arguments);v(this,"worldScale",3);v(this,"setZoomTo",t=>{});v(this,"zoomToCoordinates",t=>{console.debug("zoomToCoordinates ",t)});v(this,"zoomToScreen",t=>{console.debug("zoomToScreen ",t)});v(this,"zoomToWorld",()=>{console.debug("zoomToWorld ")});v(this,"fitNodesToScreen",t=>{console.debug("fitNodesToScreen",t)})}setUpCamera(){this.drag().pinch({percent:1}).wheel().decelerate().clamp({direction:"all",underflow:"center"}).clampZoom({minWidth:this.screenWidth/4,minHeight:this.screenHeight/4,maxWidth:this.worldWidth,maxHeight:this.worldHeight})}}class _t{constructor(n,t){v(this,"app");v(this,"stateCtrl");v(this,"camera");v(this,"worldScale",5);v(this,"canvasOptions");v(this,"debug_mode");v(this,"settings");v(this,"debugBorderGfx");v(this,"startNew",()=>{this.camera.removeChildren(),this.camera.addChild(this.debugBorderGfx)});v(this,"setDebug",n=>{this.debug_mode=n});v(this,"debugOn",()=>{this.debug_mode=!0});v(this,"debugOff",()=>{this.debug_mode=!1});var r;if(console.log("CanvasBase settings",n),!n.containerDiv)throw"containerDiv cannot be null";this.debug_mode=!0,this.stateCtrl=t,this.settings=n,this.debugBorderGfx=new O;const i=(r=this.settings.containerDiv)==null?void 0:r.getBoundingClientRect();if((i==null?void 0:i.width)===0||(i==null?void 0:i.height)===0)throw`cannot draw canvas in a div with dimensions ${JSON.stringify(i)}`;this.canvasOptions=this.getDefaultOptions(i==null?void 0:i.width,i==null?void 0:i.height),this.app=this.createApp(this.canvasOptions.screenWidth,this.canvasOptions.screenHeight),this.camera=new mt({events:this.app.renderer.events,...this.canvasOptions}),this.camera.setUpCamera(),this.app.stage.addChild(this.camera),this.app.start(),this.startNew()}getDefaultOptions(n,t){return{screenWidth:n,screenHeight:t,worldWidth:n*this.worldScale,worldHeight:t*this.worldScale}}createApp(n,t){const i=new pt({width:n,height:t,view:this.settings.containerDiv,antialias:!0,resizeTo:window,autoStart:!0,autoDensity:!1,resolution:window.devicePixelRatio,backgroundColor:this.settings.backgroundColor||2763822,eventMode:"static"});return i.stage.interactive=!0,i.stage.hitArea=i.screen,i.view.addEventListener("wheel",r=>{r.preventDefault()}),i}}var Ct={value:()=>{}};function st(){for(var e=0,n=arguments.length,t={},i;e<n;++e){if(!(i=arguments[e]+"")||i in t||/[\s.]/.test(i))throw new Error("illegal type: "+i);t[i]=[]}return new R(t)}function R(e){this._=e}function bt(e,n){return e.trim().split(/^|\s+/).map(function(t){var i="",r=t.indexOf(".");if(r>=0&&(i=t.slice(r+1),t=t.slice(0,r)),t&&!n.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:i}})}R.prototype=st.prototype={constructor:R,on:function(e,n){var t=this._,i=bt(e+"",t),r,s=-1,a=i.length;if(arguments.length<2){for(;++s<a;)if((r=(e=i[s]).type)&&(r=Dt(t[r],e.name)))return r;return}if(n!=null&&typeof n!="function")throw new Error("invalid callback: "+n);for(;++s<a;)if(r=(e=i[s]).type)t[r]=K(t[r],e.name,n);else if(n==null)for(r in t)t[r]=K(t[r],e.name,null);return this},copy:function(){var e={},n=this._;for(var t in n)e[t]=n[t].slice();return new R(e)},call:function(e,n){if((r=arguments.length-2)>0)for(var t=new Array(r),i=0,r,s;i<r;++i)t[i]=arguments[i+2];if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(s=this._[e],i=0,r=s.length;i<r;++i)s[i].value.apply(n,t)},apply:function(e,n,t){if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(var i=this._[e],r=0,s=i.length;r<s;++r)i[r].value.apply(n,t)}};function Dt(e,n){for(var t=0,i=e.length,r;t<i;++t)if((r=e[t]).name===n)return r.value}function K(e,n,t){for(var i=0,r=e.length;i<r;++i)if(e[i].name===n){e[i]=Ct,e=e.slice(0,i).concat(e.slice(i+1));break}return t!=null&&e.push({name:n,value:t}),e}var E=0,X=0,W=0,at=1e3,$,Y,j=0,B=0,V=0,F=typeof performance=="object"&&performance.now?performance:Date,ot=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function ht(){return B||(ot(Nt),B=F.now()+V)}function Nt(){B=0}function Q(){this._call=this._time=this._next=null}Q.prototype=ct.prototype={constructor:Q,restart:function(e,n,t){if(typeof e!="function")throw new TypeError("callback is not a function");t=(t==null?ht():+t)+(n==null?0:+n),!this._next&&Y!==this&&(Y?Y._next=this:$=this,Y=this),this._call=e,this._time=t,U()},stop:function(){this._call&&(this._call=null,this._time=1/0,U())}};function ct(e,n,t){var i=new Q;return i.restart(e,n,t),i}function Mt(){ht(),++E;for(var e=$,n;e;)(n=B-e._time)>=0&&e._call.call(void 0,n),e=e._next;--E}function tt(){B=(j=F.now())+V,E=X=0;try{Mt()}finally{E=0,St(),B=0}}function kt(){var e=F.now(),n=e-j;n>at&&(V-=n,j=e)}function St(){for(var e,n=$,t,i=1/0;n;)n._call?(i>n._time&&(i=n._time),e=n,n=n._next):(t=n._next,n._next=null,n=e?e._next=t:$=t);Y=e,U(i)}function U(e){if(!E){X&&(X=clearTimeout(X));var n=e-B;n>24?(e<1/0&&(X=setTimeout(tt,e-F.now()-V)),W&&(W=clearInterval(W))):(W||(j=F.now(),W=setInterval(kt,at)),E=1,ot(tt))}}function At(e,n){var t,i=1;e==null&&(e=0),n==null&&(n=0);function r(){var s,a=t.length,c,d=0,o=0;for(s=0;s<a;++s)c=t[s],d+=c.x,o+=c.y;for(d=(d/a-e)*i,o=(o/a-n)*i,s=0;s<a;++s)c=t[s],c.x-=d,c.y-=o}return r.initialize=function(s){t=s},r.x=function(s){return arguments.length?(e=+s,r):e},r.y=function(s){return arguments.length?(n=+s,r):n},r.strength=function(s){return arguments.length?(i=+s,r):i},r}function It(e){const n=+this._x.call(null,e),t=+this._y.call(null,e);return lt(this.cover(n,t),n,t,e)}function lt(e,n,t,i){if(isNaN(n)||isNaN(t))return e;var r,s=e._root,a={data:i},c=e._x0,d=e._y0,o=e._x1,g=e._y1,m,p,u,y,l,h,f,w;if(!s)return e._root=a,e;for(;s.length;)if((l=n>=(m=(c+o)/2))?c=m:o=m,(h=t>=(p=(d+g)/2))?d=p:g=p,r=s,!(s=s[f=h<<1|l]))return r[f]=a,e;if(u=+e._x.call(null,s.data),y=+e._y.call(null,s.data),n===u&&t===y)return a.next=s,r?r[f]=a:e._root=a,e;do r=r?r[f]=new Array(4):e._root=new Array(4),(l=n>=(m=(c+o)/2))?c=m:o=m,(h=t>=(p=(d+g)/2))?d=p:g=p;while((f=h<<1|l)===(w=(y>=p)<<1|u>=m));return r[w]=s,r[f]=a,e}function Pt(e){var n,t,i=e.length,r,s,a=new Array(i),c=new Array(i),d=1/0,o=1/0,g=-1/0,m=-1/0;for(t=0;t<i;++t)isNaN(r=+this._x.call(null,n=e[t]))||isNaN(s=+this._y.call(null,n))||(a[t]=r,c[t]=s,r<d&&(d=r),r>g&&(g=r),s<o&&(o=s),s>m&&(m=s));if(d>g||o>m)return this;for(this.cover(d,o).cover(g,m),t=0;t<i;++t)lt(this,a[t],c[t],e[t]);return this}function zt(e,n){if(isNaN(e=+e)||isNaN(n=+n))return this;var t=this._x0,i=this._y0,r=this._x1,s=this._y1;if(isNaN(t))r=(t=Math.floor(e))+1,s=(i=Math.floor(n))+1;else{for(var a=r-t||1,c=this._root,d,o;t>e||e>=r||i>n||n>=s;)switch(o=(n<i)<<1|e<t,d=new Array(4),d[o]=c,c=d,a*=2,o){case 0:r=t+a,s=i+a;break;case 1:t=r-a,s=i+a;break;case 2:r=t+a,i=s-a;break;case 3:t=r-a,i=s-a;break}this._root&&this._root.length&&(this._root=c)}return this._x0=t,this._y0=i,this._x1=r,this._y1=s,this}function Tt(){var e=[];return this.visit(function(n){if(!n.length)do e.push(n.data);while(n=n.next)}),e}function Lt(e){return arguments.length?this.cover(+e[0][0],+e[0][1]).cover(+e[1][0],+e[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]}function M(e,n,t,i,r){this.node=e,this.x0=n,this.y0=t,this.x1=i,this.y1=r}function Bt(e,n,t){var i,r=this._x0,s=this._y0,a,c,d,o,g=this._x1,m=this._y1,p=[],u=this._root,y,l;for(u&&p.push(new M(u,r,s,g,m)),t==null?t=1/0:(r=e-t,s=n-t,g=e+t,m=n+t,t*=t);y=p.pop();)if(!(!(u=y.node)||(a=y.x0)>g||(c=y.y0)>m||(d=y.x1)<r||(o=y.y1)<s))if(u.length){var h=(a+d)/2,f=(c+o)/2;p.push(new M(u[3],h,f,d,o),new M(u[2],a,f,h,o),new M(u[1],h,c,d,f),new M(u[0],a,c,h,f)),(l=(n>=f)<<1|e>=h)&&(y=p[p.length-1],p[p.length-1]=p[p.length-1-l],p[p.length-1-l]=y)}else{var w=e-+this._x.call(null,u.data),_=n-+this._y.call(null,u.data),x=w*w+_*_;if(x<t){var C=Math.sqrt(t=x);r=e-C,s=n-C,g=e+C,m=n+C,i=u.data}}return i}function Ot(e){if(isNaN(g=+this._x.call(null,e))||isNaN(m=+this._y.call(null,e)))return this;var n,t=this._root,i,r,s,a=this._x0,c=this._y0,d=this._x1,o=this._y1,g,m,p,u,y,l,h,f;if(!t)return this;if(t.length)for(;;){if((y=g>=(p=(a+d)/2))?a=p:d=p,(l=m>=(u=(c+o)/2))?c=u:o=u,n=t,!(t=t[h=l<<1|y]))return this;if(!t.length)break;(n[h+1&3]||n[h+2&3]||n[h+3&3])&&(i=n,f=h)}for(;t.data!==e;)if(r=t,!(t=t.next))return this;return(s=t.next)&&delete t.next,r?(s?r.next=s:delete r.next,this):n?(s?n[h]=s:delete n[h],(t=n[0]||n[1]||n[2]||n[3])&&t===(n[3]||n[2]||n[1]||n[0])&&!t.length&&(i?i[f]=t:this._root=t),this):(this._root=s,this)}function Et(e){for(var n=0,t=e.length;n<t;++n)this.remove(e[n]);return this}function Wt(){return this._root}function Xt(){var e=0;return this.visit(function(n){if(!n.length)do++e;while(n=n.next)}),e}function Yt(e){var n=[],t,i=this._root,r,s,a,c,d;for(i&&n.push(new M(i,this._x0,this._y0,this._x1,this._y1));t=n.pop();)if(!e(i=t.node,s=t.x0,a=t.y0,c=t.x1,d=t.y1)&&i.length){var o=(s+c)/2,g=(a+d)/2;(r=i[3])&&n.push(new M(r,o,g,c,d)),(r=i[2])&&n.push(new M(r,s,g,o,d)),(r=i[1])&&n.push(new M(r,o,a,c,g)),(r=i[0])&&n.push(new M(r,s,a,o,g))}return this}function Gt(e){var n=[],t=[],i;for(this._root&&n.push(new M(this._root,this._x0,this._y0,this._x1,this._y1));i=n.pop();){var r=i.node;if(r.length){var s,a=i.x0,c=i.y0,d=i.x1,o=i.y1,g=(a+d)/2,m=(c+o)/2;(s=r[0])&&n.push(new M(s,a,c,g,m)),(s=r[1])&&n.push(new M(s,g,c,d,m)),(s=r[2])&&n.push(new M(s,a,m,g,o)),(s=r[3])&&n.push(new M(s,g,m,d,o))}t.push(i)}for(;i=t.pop();)e(i.node,i.x0,i.y0,i.x1,i.y1);return this}function Ft(e){return e[0]}function Ht(e){return arguments.length?(this._x=e,this):this._x}function Rt(e){return e[1]}function $t(e){return arguments.length?(this._y=e,this):this._y}function J(e,n,t){var i=new q(n??Ft,t??Rt,NaN,NaN,NaN,NaN);return e==null?i:i.addAll(e)}function q(e,n,t,i,r,s){this._x=e,this._y=n,this._x0=t,this._y0=i,this._x1=r,this._y1=s,this._root=void 0}function et(e){for(var n={data:e.data},t=n;e=e.next;)t=t.next={data:e.data};return n}var k=J.prototype=q.prototype;k.copy=function(){var e=new q(this._x,this._y,this._x0,this._y0,this._x1,this._y1),n=this._root,t,i;if(!n)return e;if(!n.length)return e._root=et(n),e;for(t=[{source:n,target:e._root=new Array(4)}];n=t.pop();)for(var r=0;r<4;++r)(i=n.source[r])&&(i.length?t.push({source:i,target:n.target[r]=new Array(4)}):n.target[r]=et(i));return e};k.add=It;k.addAll=Pt;k.cover=zt;k.data=Tt;k.extent=Lt;k.find=Bt;k.remove=Ot;k.removeAll=Et;k.root=Wt;k.size=Xt;k.visit=Yt;k.visitAfter=Gt;k.x=Ht;k.y=$t;function L(e){return function(){return e}}function T(e){return(e()-.5)*1e-6}function jt(e){return e.x+e.vx}function Vt(e){return e.y+e.vy}function Qt(e){var n,t,i,r=1,s=1;typeof e!="function"&&(e=L(e==null?1:+e));function a(){for(var o,g=n.length,m,p,u,y,l,h,f=0;f<s;++f)for(m=J(n,jt,Vt).visitAfter(c),o=0;o<g;++o)p=n[o],l=t[p.index],h=l*l,u=p.x+p.vx,y=p.y+p.vy,m.visit(w);function w(_,x,C,N,S){var b=_.data,A=_.r,D=l+A;if(b){if(b.index>p.index){var P=u-b.x-b.vx,z=y-b.y-b.vy,I=P*P+z*z;I<D*D&&(P===0&&(P=T(i),I+=P*P),z===0&&(z=T(i),I+=z*z),I=(D-(I=Math.sqrt(I)))/I*r,p.vx+=(P*=I)*(D=(A*=A)/(h+A)),p.vy+=(z*=I)*D,b.vx-=P*(D=1-D),b.vy-=z*D)}return}return x>u+D||N<u-D||C>y+D||S<y-D}}function c(o){if(o.data)return o.r=t[o.data.index];for(var g=o.r=0;g<4;++g)o[g]&&o[g].r>o.r&&(o.r=o[g].r)}function d(){if(n){var o,g=n.length,m;for(t=new Array(g),o=0;o<g;++o)m=n[o],t[m.index]=+e(m,o,n)}}return a.initialize=function(o,g){n=o,i=g,d()},a.iterations=function(o){return arguments.length?(s=+o,a):s},a.strength=function(o){return arguments.length?(r=+o,a):r},a.radius=function(o){return arguments.length?(e=typeof o=="function"?o:L(+o),d(),a):e},a}function Ut(e){return e.index}function nt(e,n){var t=e.get(n);if(!t)throw new Error("node not found: "+n);return t}function Zt(e){var n=Ut,t=m,i,r=L(30),s,a,c,d,o,g=1;e==null&&(e=[]);function m(h){return 1/Math.min(c[h.source.index],c[h.target.index])}function p(h){for(var f=0,w=e.length;f<g;++f)for(var _=0,x,C,N,S,b,A,D;_<w;++_)x=e[_],C=x.source,N=x.target,S=N.x+N.vx-C.x-C.vx||T(o),b=N.y+N.vy-C.y-C.vy||T(o),A=Math.sqrt(S*S+b*b),A=(A-s[_])/A*h*i[_],S*=A,b*=A,N.vx-=S*(D=d[_]),N.vy-=b*D,C.vx+=S*(D=1-D),C.vy+=b*D}function u(){if(a){var h,f=a.length,w=e.length,_=new Map(a.map((C,N)=>[n(C,N,a),C])),x;for(h=0,c=new Array(f);h<w;++h)x=e[h],x.index=h,typeof x.source!="object"&&(x.source=nt(_,x.source)),typeof x.target!="object"&&(x.target=nt(_,x.target)),c[x.source.index]=(c[x.source.index]||0)+1,c[x.target.index]=(c[x.target.index]||0)+1;for(h=0,d=new Array(w);h<w;++h)x=e[h],d[h]=c[x.source.index]/(c[x.source.index]+c[x.target.index]);i=new Array(w),y(),s=new Array(w),l()}}function y(){if(a)for(var h=0,f=e.length;h<f;++h)i[h]=+t(e[h],h,e)}function l(){if(a)for(var h=0,f=e.length;h<f;++h)s[h]=+r(e[h],h,e)}return p.initialize=function(h,f){a=h,o=f,u()},p.links=function(h){return arguments.length?(e=h,u(),p):e},p.id=function(h){return arguments.length?(n=h,p):n},p.iterations=function(h){return arguments.length?(g=+h,p):g},p.strength=function(h){return arguments.length?(t=typeof h=="function"?h:L(+h),y(),p):t},p.distance=function(h){return arguments.length?(r=typeof h=="function"?h:L(+h),l(),p):r},p}const Jt=1664525,qt=1013904223,it=4294967296;function Kt(){let e=1;return()=>(e=(Jt*e+qt)%it)/it}function te(e){return e.x}function ee(e){return e.y}var ne=10,ie=Math.PI*(3-Math.sqrt(5));function re(e){var n,t=1,i=.001,r=1-Math.pow(i,1/300),s=0,a=.6,c=new Map,d=ct(m),o=st("tick","end"),g=Kt();e==null&&(e=[]);function m(){p(),o.call("tick",n),t<i&&(d.stop(),o.call("end",n))}function p(l){var h,f=e.length,w;l===void 0&&(l=1);for(var _=0;_<l;++_)for(t+=(s-t)*r,c.forEach(function(x){x(t)}),h=0;h<f;++h)w=e[h],w.fx==null?w.x+=w.vx*=a:(w.x=w.fx,w.vx=0),w.fy==null?w.y+=w.vy*=a:(w.y=w.fy,w.vy=0);return n}function u(){for(var l=0,h=e.length,f;l<h;++l){if(f=e[l],f.index=l,f.fx!=null&&(f.x=f.fx),f.fy!=null&&(f.y=f.fy),isNaN(f.x)||isNaN(f.y)){var w=ne*Math.sqrt(.5+l),_=l*ie;f.x=w*Math.cos(_),f.y=w*Math.sin(_)}(isNaN(f.vx)||isNaN(f.vy))&&(f.vx=f.vy=0)}}function y(l){return l.initialize&&l.initialize(e,g),l}return u(),n={tick:p,restart:function(){return d.restart(m),n},stop:function(){return d.stop(),n},nodes:function(l){return arguments.length?(e=l,u(),c.forEach(y),n):e},alpha:function(l){return arguments.length?(t=+l,n):t},alphaMin:function(l){return arguments.length?(i=+l,n):i},alphaDecay:function(l){return arguments.length?(r=+l,n):+r},alphaTarget:function(l){return arguments.length?(s=+l,n):s},velocityDecay:function(l){return arguments.length?(a=1-l,n):1-a},randomSource:function(l){return arguments.length?(g=l,c.forEach(y),n):g},force:function(l,h){return arguments.length>1?(h==null?c.delete(l):c.set(l,y(h)),n):c.get(l)},find:function(l,h,f){var w=0,_=e.length,x,C,N,S,b;for(f==null?f=1/0:f*=f,w=0;w<_;++w)S=e[w],x=l-S.x,C=h-S.y,N=x*x+C*C,N<f&&(b=S,f=N);return b},on:function(l,h){return arguments.length>1?(o.on(l,h),n):o.on(l)}}}function se(){var e,n,t,i,r=L(-30),s,a=1,c=1/0,d=.81;function o(u){var y,l=e.length,h=J(e,te,ee).visitAfter(m);for(i=u,y=0;y<l;++y)n=e[y],h.visit(p)}function g(){if(e){var u,y=e.length,l;for(s=new Array(y),u=0;u<y;++u)l=e[u],s[l.index]=+r(l,u,e)}}function m(u){var y=0,l,h,f=0,w,_,x;if(u.length){for(w=_=x=0;x<4;++x)(l=u[x])&&(h=Math.abs(l.value))&&(y+=l.value,f+=h,w+=h*l.x,_+=h*l.y);u.x=w/f,u.y=_/f}else{l=u,l.x=l.data.x,l.y=l.data.y;do y+=s[l.data.index];while(l=l.next)}u.value=y}function p(u,y,l,h){if(!u.value)return!0;var f=u.x-n.x,w=u.y-n.y,_=h-y,x=f*f+w*w;if(_*_/d<x)return x<c&&(f===0&&(f=T(t),x+=f*f),w===0&&(w=T(t),x+=w*w),x<a&&(x=Math.sqrt(a*x)),n.vx+=f*u.value*i/x,n.vy+=w*u.value*i/x),!0;if(u.length||x>=c)return;(u.data!==n||u.next)&&(f===0&&(f=T(t),x+=f*f),w===0&&(w=T(t),x+=w*w),x<a&&(x=Math.sqrt(a*x)));do u.data!==n&&(_=s[u.data.index]*i/x,n.vx+=f*_,n.vy+=w*_);while(u=u.next)}return o.initialize=function(u,y){e=u,t=y,g()},o.strength=function(u){return arguments.length?(r=typeof u=="function"?u:L(+u),g(),o):r},o.distanceMin=function(u){return arguments.length?(a=u*u,o):Math.sqrt(a)},o.distanceMax=function(u){return arguments.length?(c=u*u,o):Math.sqrt(c)},o.theta=function(u){return arguments.length?(d=u*u,o):Math.sqrt(d)},o}function G(e,n,t){this.k=e,this.x=n,this.y=t}G.prototype={constructor:G,scale:function(e){return e===1?this:new G(this.k*e,this.x,this.y)},translate:function(e,n){return e===0&n===0?this:new G(this.k,this.x+this.k*e,this.y+this.k*n)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};G.prototype;class ae{constructor(n){v(this,"canvas");v(this,"simulation");v(this,"getCenter",()=>{const{worldWidth:n,worldHeight:t}=this.canvas.canvasOptions;return{centerX:n/2,centerY:t/2}});v(this,"ticked",()=>{this.canvas.fitView(),this.canvas.renderer.tick()});v(this,"reDoLayout",()=>{this.simulation.alpha(.1).restart()});this.canvas=n}createSimulation(){const n=this,{centerX:t,centerY:i}=this.getCenter(),r=this.canvas.stateCtrl.getNodes(),s=this.canvas.stateCtrl.getLinks();return re(r).force("link",Zt(s).id(c=>c.id).distance(c=>150)).force("charge",se().strength(-350)).force("center",At(t,i)).force("collision",Qt().radius(c=>c.size+15).iterations(2)).stop().tick(1e3).on("tick",this.ticked.bind(this)).on("end",()=>{console.log("=Simulation ended"),n.simulation.stop(),n.ticked(),n.canvas.fitView()})}add2Layout(n,t){this.simulation=this.createSimulation(),this.reDoLayout()}}class oe extends _t{constructor(t,i){super(t,i);v(this,"renderer");v(this,"layout");v(this,"setDebug",t=>{this.debug_mode=t});v(this,"debugOn",()=>{this.debug_mode=!0});v(this,"debugOff",()=>{this.debug_mode=!1});v(this,"zoomIn",()=>{this.camera.zoom(-this.camera.screenWidth/10,!0)});v(this,"zoomOut",()=>{this.camera.zoom(this.camera.screenWidth/10,!0)});v(this,"zoomLevel",()=>{});v(this,"zoomTo",()=>{});this.renderer=new yt(this),this.layout=new ae(this)}screenBorderClear(){console.debug("screenBorderClear"),this.debugBorderGfx.clear(),this.debugBorderGfx.removeChildren()}screenBorderDraw(){this.screenBorderClear(),console.debug("screenBorderDraw triggered");const t=1749995,{center:i,min:r,max:s,graphHeight:a,graphWidth:c}=this.getCenter(this.stateCtrl.getNodes()),d=new Z(`[${Math.round(c)},${Math.round(a)}] - allNodes boundingBox`,{fontFamily:"Courier New",fontSize:12,fill:t});d.x=r.x,d.y=r.y-10,d.anchor.set(.5),this.debugBorderGfx.addChild(d),this.debugBorderGfx.lineStyle(2,t).drawRect(r.x,r.y,s.x-r.x,s.y-r.y)}addShape(t){this.camera.addChild(t)}clear(){console.log("canvas.clear triggered"),this.startNew()}fitView(t,i){console.log("==fitView",t,i),t||(t=this.stateCtrl.getNodes());const{center:r}=this.getCenter(t);this.camera.moveCenter(r)}getNodesPOV(t){const i=t.map(m=>m.x),r=t.map(m=>m.y),s=Math.min(...i),a=Math.max(...i),c=Math.min(...r),d=Math.max(...r),o=new H(s,c),g=new H(a,d);return{min:o,max:g}}getCenter(t){const{min:i,max:r}=this.getNodesPOV(t),s=0,a=Math.abs(r.x-i.x)+s*2,c=Math.abs(r.y-i.y)+s*2;return{center:new H(i.x+a/2,i.y+c/2),max:r,min:i,graphWidth:a,graphHeight:c}}moveNodesToWorldCenter(t){t&&(t=this.stateCtrl.getNodes());const i=t.map(l=>l.x),r=t.map(l=>l.y),s=Math.min(...i),a=Math.max(...i),c=Math.min(...r),d=Math.max(...r),o=Math.abs(a-s),g=Math.abs(d-c),m=new H(s+o/2,c+g/2),p=50,u=o+p*this.worldScale,y=g+p*this.worldScale;this.camera.resize(u,y,this.camera.worldWidth,this.camera.worldHeight),this.camera.center=m,this.camera.fit(!0)}focusNode(t,i){this.moveToPosition(t.x,t.y)}}class he{constructor(){v(this,"nodes");v(this,"links");v(this,"addData",(n,t)=>{for(const i of n)console.log("==node====",i),this.nodes.has(i.id)||this.nodes.set(i.id,i);for(const i of t)console.log("==link====",i),this.links.has(i.id)||this.links.set(i.id,i)});this.links=new Map,this.nodes=new Map}clearAll(){this.links=new Map,this.nodes=new Map}getNodes(){return Array.from(this.nodes.values())}getLinks(){return Array.from(this.links.values())}getNeighborLinks(n){return this.getLinks().filter(t=>t.source.id===n.id||t.target.id===n.id)}isINode(n){return typeof n=="object"&&n!==null&&"id"in n&&"type"in n}updateNodePosition(n,t,i){var s;let r=this.nodes.get(n);r&&(r.x=t,r.y=i,(s=r.shapeGfx)==null||s.position.set(t,i),this.nodes.set(n,r))}}class fe{constructor(n){v(this,"settings");v(this,"stateCtrl");v(this,"canvasCtrl");v(this,"addData",(n,t)=>{console.log("Adding nodes and edges",n,t),this.stateCtrl.addData(n,t),this.canvasCtrl.layout.add2Layout(n,t),this.canvasCtrl.renderer.render()});this.settings=n,this.stateCtrl=new he,this.canvasCtrl=new oe(n.canvas,this.stateCtrl)}}export{fe as G};
